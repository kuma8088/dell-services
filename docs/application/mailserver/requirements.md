# メールサーバー要件定義

**作成者**: kuma8088（AWS認定ソリューションアーキテクト、ITストラテジスト）
**技術スタック**: Docker Compose, Postfix, Dovecot, Cloudflare

---

## 1. プロジェクト背景と目的

### 1.1 解決すべき課題

| 課題 | 詳細 | 影響 |
|-----|------|-----|
| レンタルサーバー依存 | Xserver等の外部メールサービスに依存 | コスト増、カスタマイズ制限 |
| 学習機会の欠如 | マネージドサービスでは運用スキルが身につかない | キャリア成長の阻害 |
| 柔軟性の欠如 | サービス仕様に縛られる | 将来の拡張が困難 |
| Port 25制約 | ISPによるPort 25ブロック | 自宅サーバーでのMX受信困難 |

### 1.2 プロジェクト目標

1. **Xserver相当のメールサーバー構築** - 複数ドメイン対応、Webメール、スパム/ウイルス対策
2. **セキュアな自己ホスティング** - Cloudflare Tunnel経由でInboundポート開放不要
3. **運用スキルの獲得** - 本番環境での障害対応、セキュリティ対策の実践
4. **ランサムウェア対策** - S3 Object Lockによる削除不可バックアップ

---

## 2. 機能要件

### 2.1 メール送受信

| 要件ID | 要件 | 優先度 | 判断理由 |
|--------|-----|--------|---------|
| M-001 | 複数ドメインでのメール送受信 | 必須 | ビジネス用途で複数ドメイン運用が必要 |
| M-002 | Webメールアクセス（Roundcube） | 必須 | モバイル環境からのアクセス |
| M-003 | IMAP/POP3対応（SSL/TLS必須） | 必須 | メールクライアント連携 |
| M-004 | 送信ドメイン認証（SPF/DKIM/DMARC） | 必須 | メール到達率確保 |

### 2.2 セキュリティ

| 要件ID | 要件 | 優先度 | 判断理由 |
|--------|-----|--------|---------|
| S-001 | スパムフィルタリング（Rspamd） | 必須 | 受信メール品質確保 |
| S-002 | ウイルススキャン（ClamAV） | 必須 | マルウェア防御 |
| S-003 | TLS暗号化（全プロトコル） | 必須 | 通信の機密性確保 |
| S-004 | SMTP認証必須 | 必須 | 不正中継防止 |

### 2.3 管理機能

| 要件ID | 要件 | 優先度 | 判断理由 |
|--------|-----|--------|---------|
| A-001 | Web UIによるユーザー管理 | 必須 | 運用負荷軽減 |
| A-002 | REST APIによるユーザー操作 | 推奨 | 自動化対応 |
| A-003 | 複数ドメイン一元管理 | 必須 | 運用効率化 |

---

## 3. 非機能要件

### 3.1 可用性・性能

| カテゴリ | 要件 | 目標値 | 測定方法 |
|---------|-----|-------|---------|
| 可用性 | システム稼働率 | 99.9% | 月次ダウンタイム計測 |
| 性能 | メール配信遅延 | 5分以内 | 送受信タイムスタンプ差分 |
| 性能 | Webメール応答時間 | 3秒以内 | ブラウザ計測 |
| 容量 | メールボックス | 2GB/ユーザー（初期） | ディスク使用量監視 |

### 3.2 バックアップ要件

#### 3-2-1ルール
| 要件 | 内容 |
|------|------|
| 3つのコピー | 本番データ + ローカルバックアップ + オフサイト |
| 2種類のメディア | SSD/HDD（ローカル）+ S3（クラウド） |
| 1つはオフサイト | AWS S3（物理的に別拠点） |

#### RPO/RTO目標
| 指標 | 目標 | 実現方法 |
|------|------|----------|
| RPO（データ損失許容） | 24時間 | 日次バックアップ |
| RTO（復旧時間目標） | 4時間 | リストアスクリプト整備 |

### 3.3 ランサムウェア対策要件

| 要件 | 対策 |
|------|------|
| バックアップ削除防止 | S3 Object Lock COMPLIANCE（管理者でも削除不可） |
| 保持期間 | 30日間（復旧猶予確保） |
| バージョニング | 全バージョン保持 |
| リストア前スキャン | ClamAV + rkhunter による検証 |

---

## 4. セキュリティ要件

### 4.1 多層防御（Defense in Depth）

| レイヤー | 要件 | 対策 |
|---------|------|------|
| エッジ | DDoS/WAF保護 | Cloudflare（L3/L4/L7防御） |
| ネットワーク | ポート開放最小化 | Cloudflare Tunnel（Inbound不要） |
| アクセス制御 | VPN限定アクセス | Tailscale（メールクライアント接続） |
| アプリケーション | スパム/ウイルス対策 | Rspamd + ClamAV |
| データ | 改ざん・削除防止 | S3 Object Lock COMPLIANCE |

### 4.2 メール認証（なりすまし防止）

| 技術 | 要件 | 目的 |
|------|------|------|
| SPF | 送信サーバー認証 | 許可されたサーバーからの送信のみ許可 |
| DKIM | 電子署名 | メール改ざん検知 |
| DMARC | ポリシー制御 | 認証失敗メールの処理ルール |

### 4.3 アクセス制御

| 対象 | 要件 | 認証方式 |
|------|------|----------|
| Webメール | 公開 | Cloudflare WAF経由 |
| IMAP/POP3/SMTP | VPN限定 | Tailscale登録デバイスのみ |
| SSH | 公開鍵のみ | パスワード認証無効、root禁止 |
| ユーザー管理UI | ローカル/VPN | 内部ネットワーク限定 |

---

## 5. ネットワーク要件

### 5.1 自宅サーバー固有の制約と対策

| 制約 | 影響 | 対策 |
|------|------|------|
| ISPによるPort 25ブロック | メール受信不可 | Cloudflare Email Routing + Worker |
| 固定IPなし | DNS設定困難 | Cloudflare Tunnel |
| ポート開放のリスク | 攻撃対象化 | Inboundポート開放なし |
| SSL証明書管理 | 運用負荷 | Cloudflare自動発行 |

### 5.2 通信経路要件

| 通信種別 | 要件 | 経路 |
|----------|------|------|
| Web公開（HTTPS） | CDN/WAF経由 | Cloudflare → Tunnel → Nginx |
| メール受信（MX） | Port 25不要 | Cloudflare Email → Worker → Tunnel → API |
| メールクライアント | VPN限定 | Tailscale → Dovecot |
| メール送信 | 高到達率 | Postfix → SendGrid Relay |

---

## 6. バックアップ対象要件

### 6.1 バックアップ対象コンポーネント

| コンポーネント | 対象データ | 優先度 | 理由 |
|---------------|-----------|--------|------|
| メールボックス | Maildir形式データ | 最高 | ユーザーデータ、復元不可 |
| データベース | MariaDB全データベース | 最高 | Roundcube、ユーザー管理 |
| 設定ファイル | Postfix, Dovecot, Nginx等 | 高 | サービス復旧に必須 |
| SSL証明書 | Let's Encrypt証明書 | 高 | HTTPS/TLS通信に必須 |
| DKIM鍵 | 秘密鍵・公開鍵ペア | 高 | メール認証に必須 |

### 6.2 バックアップスケジュール

| 種別 | 頻度 | 保持期間 | 実行時間 |
|------|------|----------|----------|
| 日次バックアップ | 毎日 | 7日間 | AM 3:00 |
| 週次バックアップ | 毎週日曜 | 4週間 | AM 2:00 |
| S3レプリケーション | 毎日 | 30日間 | AM 4:00 |

---

## 7. トレードオフ分析

### 7.1 メール受信方式の選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **EC2 MXゲートウェイ** | 標準的、実績あり | EC2コスト（月額$3程度）、運用負荷 | × |
| **Cloudflare Email Routing** | 無料、高信頼性 | Cloudflare依存 | ✓ |
| **AWS SES受信** | AWS統合 | 利用ハードル高 | × |

**判断根拠**:
- 当初EC2を使用 → Cloudflare Email Routingに移行
- **コスト削減（月額$3→$0）+ 運用簡素化**
- Cloudflare Tunnel併用で統一的なアーキテクチャ

### 7.2 メール送信方式の選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **直接送信** | コスト0 | IP評価問題、ブロックリスク | × |
| **SendGrid Relay** | 高到達率、無料枠あり | 外部依存 | ✓ |
| **AWS SES** | AWS統合 | 利用ハードル高 | × |

**判断根拠**:
- 自宅IPからの直接送信はスパム判定リスクが高い
- SendGridは100通/日まで無料、SPF/DKIM/DMARC管理が容易
- **到達率優先でSendGrid採用**

### 7.3 バックアップストレージの選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **ローカルHDDのみ** | コスト最小 | 物理障害で全滅 | × |
| **S3 Standard** | 高可用性 | ランサムウェアで削除リスク | × |
| **S3 Object Lock** | 削除不可、高耐久性 | やや高コスト | ✓ |

**判断根拠**:
- ランサムウェア対策を最優先
- Object Lock COMPLIANCEモードで管理者でも削除不可
- **データ保護優先でObject Lock採用**

---

## 8. 教訓と改善点

### 8.1 当初の失敗と学び

1. **AWS Fargate採用 → EC2へ変更**
   - 問題: FargateコンテナからTailscale VPNへのアクセス制限
   - 学び: サーバーレスの制約を事前に検証すべき

2. **EC2 MXゲートウェイ → Cloudflare Email Routing**
   - 問題: EC2維持コスト、OS/セキュリティパッチ運用負荷
   - 学び: マネージドサービスの活用でコア業務に集中

3. **手動ユーザー管理 → Web UI化**
   - 問題: adduser.sh実行の運用負荷
   - 学び: 定型作業はUI化で効率化

### 8.2 設計原則

- **動くものを作る → 運用しながら最適化** のイテレーティブアプローチ
- **コスト意識**: 無料枠・マネージドサービスを積極活用
- **セキュリティファースト**: ポート開放最小化、多層防御

---

## 9. 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| [architecture.md](architecture.md) | システムアーキテクチャ・コンポーネント設計 |
| [deployment.md](deployment.md) | デプロイ戦略・Docker Compose設定 |
| [operations.md](operations.md) | 運用設計・監視・バックアップ運用 |
