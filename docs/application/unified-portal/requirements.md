# 統合管理ポータル要件定義

**技術スタック**: FastAPI, React, TypeScript, Tailwind CSS, Docker Compose

---

## 1. プロジェクト背景と目的

### 1.1 解決すべき課題

| 課題 | 詳細 | 影響 |
|-----|------|------|
| 管理画面分散 | Flask usermgmt、Cloudflare Web UI、各種CLI | 運用効率低下 |
| 操作の煩雑さ | 複数システム切り替え | 操作ミスのリスク |
| 監視・ログ未統一 | システムごとに異なるログ確認方法 | 障害対応遅延 |
| UI/UX旧式 | Flask usermgmtは機能的だが古いデザイン | ユーザビリティ低下 |

### 1.2 プロジェクト目標

1. **統一管理** - ブログシステム + メールサーバー + Cloudflare DNSを一元管理
2. **運用効率化** - 運用時間50%削減目標
3. **モダンUI/UX** - Xserver風の直感的なインターフェース
4. **監視統合** - リアルタイム監視とアラート機能

---

## 2. 機能要件

### 2.1 ダッシュボード

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| DASH-001 | システム全体の健全性表示 | 必須 | ✅ 完了 |
| DASH-002 | リソース使用状況（CPU, RAM, ディスク） | 必須 | ✅ 完了 |
| DASH-003 | サービスステータス一覧 | 必須 | ✅ 完了 |
| DASH-004 | 最近のアクティビティ表示 | 推奨 | ✅ 完了 |
| DASH-005 | アラート通知表示 | 推奨 | ✅ 完了 |

### 2.2 ドメイン管理（Cloudflare DNS）

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| DNS-001 | Cloudflareゾーン一覧表示 | 必須 | ✅ 完了 |
| DNS-002 | DNSレコードCRUD操作 | 必須 | ✅ 完了 |
| DNS-003 | Cloudflareプロキシ設定 | 必須 | ✅ 完了 |
| DNS-004 | TTL設定 | 必須 | ✅ 完了 |
| DNS-005 | DNSレコード編集 | 推奨 | ✅ 完了 |
| DNS-006 | バルク操作（一括削除、CSV） | 推奨 | 計画中 |

### 2.3 Docker管理

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| DOCK-001 | コンテナ一覧表示 | 必須 | ✅ 完了 |
| DOCK-002 | コンテナ起動/停止/再起動 | 必須 | ✅ 完了 |
| DOCK-003 | リアルタイムログ表示 | 必須 | ✅ 完了 |
| DOCK-004 | リソース使用状況表示 | 推奨 | ✅ 完了 |
| DOCK-005 | イメージ管理 | 推奨 | 計画中 |

### 2.4 WordPress管理

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| WP-001 | 17サイト一覧表示 | 必須 | ✅ 完了 |
| WP-002 | 新規サイト作成ウィザード | 必須 | ✅ 完了 |
| WP-003 | サイト設定編集 | 必須 | ✅ 完了 |
| WP-004 | プラグイン/テーマ管理 | 推奨 | 計画中 |
| WP-005 | WP Mail SMTP一括設定 | 推奨 | 計画中 |

### 2.5 データベース管理

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| DB-001 | データベース一覧表示 | 必須 | ✅ 完了 |
| DB-002 | 新規データベース作成 | 必須 | ✅ 完了 |
| DB-003 | ユーザー管理 | 必須 | ✅ 完了 |
| DB-004 | SQLクエリ実行（制限付き） | 推奨 | ✅ 完了 |
| DB-005 | エクスポート/インポート | 推奨 | 計画中 |

### 2.6 メールサーバー管理

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| MAIL-001 | メールユーザーCRUD | 必須 | ✅ 完了 |
| MAIL-002 | メールドメイン管理 | 必須 | ✅ 完了 |
| MAIL-003 | 監査ログ表示 | 必須 | ✅ 完了 |
| MAIL-004 | 既存Flask usermgmtとの互換性 | 必須 | ✅ 完了 |

### 2.7 バックアップ管理

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| BK-001 | バックアップ一覧表示 | 必須 | ✅ 完了 |
| BK-002 | 手動バックアップ実行 | 必須 | ✅ 完了 |
| BK-003 | リストア操作 | 必須 | ✅ 完了 |
| BK-004 | S3同期状況表示 | 推奨 | ✅ 完了 |
| BK-005 | スケジュール設定UI | 推奨 | 計画中 |

### 2.8 セキュリティ管理

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| SEC-001 | セキュリティスコア表示 | 推奨 | ✅ 完了 |
| SEC-002 | 脆弱性チェック | 推奨 | ✅ 完了 |
| SEC-003 | SSL証明書ステータス | 推奨 | ✅ 完了 |
| SEC-004 | セキュリティヘッダー確認 | 推奨 | ✅ 完了 |

### 2.9 PHP管理

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| PHP-001 | PHP設定表示 | 必須 | ✅ 完了 |
| PHP-002 | PHP設定変更 | 必須 | ✅ 完了 |
| PHP-003 | PHPバージョン情報 | 推奨 | ✅ 完了 |

### 2.10 認証・ユーザー管理

| 要件ID | 要件 | 優先度 | 状況 |
|--------|-----|--------|------|
| AUTH-001 | ログイン/ログアウト | 必須 | ✅ 完了 |
| AUTH-002 | JWT認証 | 必須 | ✅ 完了 |
| AUTH-003 | 管理者ユーザー管理 | 必須 | ✅ 完了 |
| AUTH-004 | ロールベースアクセス制御 | 推奨 | 計画中 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| カテゴリ | 要件 | 目標値 |
|---------|-----|--------|
| API応答 | レスポンスタイム | 平均 < 500ms |
| API応答 | 95パーセンタイル | < 1000ms |
| UI | 初回ページロード | < 3秒 |
| UI | キャッシュ後ロード | < 1秒 |
| 同時接続 | 同時ユーザー数 | 10ユーザー |

### 3.2 セキュリティ

| 項目 | 要件 |
|------|------|
| 認証 | JWT（HS256、有効期限15分） |
| 通信 | HTTPS必須（Cloudflare Tunnel経由） |
| CORS | フロントエンドドメインのみ許可 |
| SQL対策 | パラメータ化クエリ徹底 |
| XSS対策 | 入力値サニタイズ、CSP設定 |
| パスワード | 管理者: bcrypt、メールユーザー: SHA512-CRYPT |

### 3.3 可用性

| 指標 | 目標 |
|------|------|
| システム稼働率 | 99.9%（月間43分以内） |
| バックアップ | 日次自動（AM 3:00） |
| RTO | 1時間以内 |
| RPO | 24時間以内 |

### 3.4 保守性

| 項目 | 目標 |
|------|------|
| テストカバレッジ | 80%以上 |
| ドキュメント | 全API、全機能 |
| ログレベル | INFO（本番）、DEBUG（開発） |

---

## 4. 制約事項

### 4.1 既存システムへの影響

| 制約 | 詳細 |
|------|------|
| 既存usermgmt | services/mailserver/usermgmt/ を変更しない |
| 並行稼働 | Flask usermgmtと同時稼働可能 |
| データベース | 既存テーブル構造を変更しない |

### 4.2 環境制約

| 制約 | 詳細 |
|------|------|
| 実行環境 | Rocky Linux 9.6 |
| ネットワーク | Docker内部ネットワーク |
| リソース | RAM 32GB、既存サービスとリソース共有 |

---

## 5. トレードオフ分析

### 5.1 フロントエンドフレームワーク選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **React + TypeScript** | エコシステム充実、型安全 | 学習コスト | ✓ |
| Vue.js | 学習容易 | エコシステムがReactより小さい | × |
| Angular | 企業向け機能充実 | 過剰な複雑性 | × |

### 5.2 バックエンドフレームワーク選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **FastAPI** | 高速、自動ドキュメント、非同期対応 | 比較的新しい | ✓ |
| Flask | シンプル、既存usermgmtと同じ | 型ヒント弱い | × |
| Django | フル機能 | 過剰な複雑性 | × |

### 5.3 UIフレームワーク選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **Tailwind + shadcn/ui** | カスタマイズ性、モダン | 設定必要 | ✓ |
| Material-UI | 豊富なコンポーネント | 重い、カスタマイズ困難 | × |
| Chakra UI | 使いやすい | コンポーネント数が少ない | × |

**判断根拠**:
- FastAPI: 自動APIドキュメント生成（OpenAPI）が運用に有利
- React: 既存のスキルセットとエコシステムの充実度
- shadcn/ui: Xserver風UIの実現に適したカスタマイズ性

---

## 6. 実装フェーズ

### Phase 1: 基盤構築（✅ 完了）

- ✅ FastAPIバックエンド基盤（10 APIルーター）
- ✅ Reactフロントエンド基盤（12ページ）
- ✅ Cloudflare DNS API統合
- ✅ Docker管理API
- ✅ WordPress管理API
- ✅ データベース管理API
- ✅ メールサーバー管理API
- ✅ バックアップ管理API
- ✅ セキュリティ管理API
- ✅ PHP管理API
- ✅ JWT認証システム
- ✅ Docker Compose本番設定

### Phase 2: 機能拡張（計画中）

- WebSocketリアルタイム更新
- 監視・アラート機能
- ログビューア機能強化
- ロールベースアクセス制御

---

## 7. 実装状況サマリー

### バックエンドAPIルーター

| ルーター | ファイル | 状況 |
|---------|---------|------|
| 認証 | auth.py | ✅ 実装済み |
| ダッシュボード | dashboard.py | ✅ 実装済み |
| Docker | docker.py | ✅ 実装済み |
| データベース | database.py | ✅ 実装済み |
| ドメイン | domains.py | ✅ 実装済み |
| WordPress | wordpress.py | ✅ 実装済み |
| バックアップ | backup.py | ✅ 実装済み |
| セキュリティ | security.py | ✅ 実装済み |
| PHP | php.py | ✅ 実装済み |
| メールサーバー | mailserver.py | ✅ 実装済み |

### フロントエンドページ

| ページ | ファイル | 状況 |
|--------|---------|------|
| ダッシュボード | Dashboard.tsx | ✅ 実装済み |
| Docker管理 | DockerManagement.tsx | ✅ 実装済み |
| データベース管理 | DatabaseManagement.tsx | ✅ 実装済み |
| ドメイン管理 | DomainManagement.tsx | ✅ 実装済み |
| WordPress管理 | WordPressManagement.tsx | ✅ 実装済み |
| バックアップ管理 | BackupManagement.tsx | ✅ 実装済み |
| セキュリティ管理 | SecurityManagement.tsx | ✅ 実装済み |
| PHP管理 | PhpManagement.tsx | ✅ 実装済み |
| メールサーバー管理 | MailserverManagement.tsx | ✅ 実装済み |
| ユーザー管理 | AdminUserManagement.tsx | ✅ 実装済み |
| サイト作成 | CreateManagedSitePage.tsx | ✅ 実装済み |
| ログイン | Login.tsx | ✅ 実装済み |

---

## 8. 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| [architecture.md](architecture.md) | システムアーキテクチャ・コンポーネント設計 |
| [deployment.md](deployment.md) | デプロイ戦略・Docker Compose設定 |
| [operations.md](operations.md) | 運用設計・監視・開発ガイド |
