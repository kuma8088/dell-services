# ブログシステム要件定義

**技術スタック**: Docker Compose, WordPress, Nginx, Cloudflare Tunnel

---

## 1. プロジェクト背景と目的

### 1.1 解決すべき課題

| 課題 | 詳細 | 影響 |
|-----|------|-----|
| レンタルサーバー依存 | Xserver等の外部サービスに依存 | 月額コスト、カスタマイズ制限 |
| データ主権 | 外部サーバーにデータ保管 | データ管理の不自由 |
| 動的IP制約 | 自宅回線は固定IPなし | 従来型のWeb公開が困難 |
| 複数サイト管理 | 16サイトの一元管理が必要 | 運用効率の問題 |

### 1.2 プロジェクト目標

1. **Xserverからの移行** - 16 WordPress サイトを自前インフラへ移植
2. **コスト削減** - 月額ホスティング費用の削減
3. **ゼロトラストアクセス** - Cloudflare Tunnel経由でポート開放不要
4. **既存インフラとの共存** - Mailserverとの統合管理

---

## 2. 機能要件

### 2.1 WordPress機能

| 要件ID | 要件 | 優先度 | 判断理由 |
|--------|-----|--------|---------|
| W-001 | 複数独立WordPressサイトのホスティング | 必須 | 16サイト移行 |
| W-002 | 記事作成・編集・メディア管理 | 必須 | 標準CMS機能 |
| W-003 | プラグイン・テーマ管理 | 必須 | サイト運営に必須 |
| W-004 | SEO対応（パーマリンク設定） | 必須 | 検索順位維持 |

### 2.2 メール送信機能

| 要件ID | 要件 | 優先度 | 判断理由 |
|--------|-----|--------|---------|
| E-001 | WP Mail SMTP統合 | 必須 | フォーム送信、通知メール |
| E-002 | SendGrid Relay経由 | 必須 | 高到達率 |
| E-003 | 16サイト一括設定 | 推奨 | 運用効率 |

### 2.3 パフォーマンス機能

| 要件ID | 要件 | 優先度 | 判断理由 |
|--------|-----|--------|---------|
| P-001 | Redis Object Cache | 推奨 | WordPress高速化 |
| P-002 | OPcache有効化 | 必須 | PHP実行高速化 |
| P-003 | 静的ファイルキャッシュ | 必須 | 表示速度向上 |

---

## 3. 非機能要件

### 3.1 可用性・性能

| カテゴリ | 要件 | 目標値 | 測定方法 |
|---------|-----|-------|---------|
| 可用性 | システム稼働率 | 99.9% | 月次ダウンタイム計測 |
| 性能 | ページ表示速度 | 3秒以内 | PageSpeed Insights |
| 性能 | DB応答時間 | 100ms以内 | クエリログ |
| 容量 | 総ストレージ | 100GB+ | ディスク監視 |

### 3.2 バックアップ要件

| 指標 | 目標 | 実現方法 |
|------|------|----------|
| RPO（データ損失許容） | 24時間 | 日次バックアップ |
| RTO（復旧時間目標） | 4時間 | リストアスクリプト整備 |
| 保持期間 | 日次7日、週次4週 | 自動ローテーション |

### 3.3 拡張性要件

| 項目 | 初期値 | 拡張目標 |
|------|--------|---------|
| サイト数 | 16サイト | 20サイト |
| 記事総数 | 現行記事数 | 5,000記事 |
| メディアファイル | 95GB | 150GB |
| 月間PV | 現行PV数 | 50,000 PV |

---

## 4. セキュリティ要件

### 4.1 多層防御

| レイヤー | 要件 | 対策 |
|---------|------|------|
| エッジ | DDoS/WAF保護 | Cloudflare（L3/L4/L7防御） |
| ネットワーク | ポート開放最小化 | Cloudflare Tunnel（Inbound不要） |
| アプリケーション | WordPress保護 | セキュリティプラグイン |
| データ | 暗号化通信 | HTTPS必須 |

### 4.2 アクセス制御

| 対象 | 要件 | 認証方式 |
|------|------|----------|
| WordPress管理画面 | 公開（WAF保護） | ユーザー認証 + Cloudflare |
| データベース | 内部のみ | Docker内部ネットワーク |
| SSH | 公開鍵のみ | パスワード認証無効 |
| ファイル操作 | コンテナ内のみ | www-data権限 |

### 4.3 WordPress セキュリティ

| 項目 | 要件 |
|------|------|
| コア更新 | 月次手動更新 |
| プラグイン更新 | 月次手動更新（テスト後） |
| ファイル編集 | 管理画面から無効化 |
| SSL強制 | 管理画面HTTPS必須 |

---

## 5. ネットワーク要件

### 5.1 自宅サーバー固有の制約と対策

| 制約 | 影響 | 対策 |
|------|------|------|
| 固定IPなし | DNS設定困難 | Cloudflare Tunnel |
| ポート開放リスク | 攻撃対象化 | Outbound接続のみ |
| SSL証明書管理 | 運用負荷 | Cloudflare自動発行 |

### 5.2 通信経路要件

| 通信種別 | 経路 |
|----------|------|
| Web公開 | User → Cloudflare Edge → Tunnel → Nginx → WordPress |
| 管理画面 | ローカル/VPN → 直接アクセス |
| DB接続 | Docker内部ネットワークのみ |

---

## 6. 移行要件

### 6.1 移行対象

| データ種別 | 内容 | 優先度 |
|-----------|------|--------|
| WordPress DB | 16サイト分のデータベース | 必須 |
| WordPress files | wp-content（プラグイン、テーマ、アップロード） | 必須 |
| 設定ファイル | wp-config.php、Nginx設定 | 必須 |

### 6.2 移行成功基準

| 基準 | 目標値 |
|------|--------|
| データ完全性 | 100%（記事数・メディア数一致） |
| URL維持 | パーマリンク構造維持 |
| ダウンタイム | 1時間以内/サイト |
| SEO影響 | 検索順位変動10%以内 |

---

## 7. トレードオフ分析

### 7.1 ホスティング方式の選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **フルクラウド（AWS）** | 高可用性 | コスト高 | × |
| **フルオンプレミス** | コスト最小 | 動的IP問題 | × |
| **ハイブリッド** | コスト最適化、柔軟性 | 複雑性 | ✓ |

### 7.2 マルチサイト構成の選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **WordPressマルチサイト** | リソース効率 | プラグイン制約、障害影響大 | × |
| **複数独立WordPress** | 完全分離、障害影響限定 | リソース消費 | ✓ |

**判断根拠**:
- プラグイン・テーマの自由な選択が必要
- 1サイトの障害が他サイトに影響しない設計
- 個別バックアップ・リストアの容易さ

### 7.3 Web公開方式の選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **ポートフォワーディング** | シンプル | セキュリティリスク、動的IP問題 | × |
| **Cloudflare Tunnel** | セキュア、動的IP対応 | Cloudflare依存 | ✓ |
| **VPN経由のみ** | 最高セキュリティ | 公開用途に不向き | × |

**判断根拠**:
- ポート開放なしでWeb公開可能
- SSL証明書自動管理
- DDoS保護・WAF標準提供

---

## 8. 教訓と改善点

### 8.1 移行時の課題と対処

1. **HTTPS検出問題**
   - 問題: Cloudflare経由でHTTPS検出が失敗
   - 対処: Nginxに`fastcgi_param HTTPS on;`追加
   - 学び: リバースプロキシ経由の環境変数設定は必須

2. **パーミッション問題**
   - 問題: プラグイン/テーマ更新失敗
   - 対処: www-data所有者に変更
   - 学び: ファイルコピー後は必ずパーミッション修正

3. **PHP互換性問題**
   - 問題: 古いテーマが`create_function()`使用
   - 対処: テーマ更新または代替テーマ
   - 学び: PHP 8.x移行時は非推奨関数チェック必須

### 8.2 設計原則

- **段階的移行**: 1サイトずつ移行・検証
- **ロールバック準備**: 並行運用期間の確保
- **自動化優先**: 16サイト管理のスクリプト化

---

## 9. 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| [architecture.md](architecture.md) | システムアーキテクチャ・コンポーネント設計 |
| [deployment.md](deployment.md) | デプロイ戦略・Docker Compose設定 |
| [operations.md](operations.md) | 運用設計・バックアップ・トラブルシューティング |
