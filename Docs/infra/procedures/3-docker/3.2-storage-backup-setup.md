# Phase 3.2: ストレージ・バックアップ設定

## 概要

Dockerボリューム、イメージ、Composeファイルのバックアップ環境を構築します。外付けHDDをマウントし、週1回の自動バックアップスクリプトを設定します。

## 前提条件

- Phase 3.1（Docker環境構築）完了
- 外付けHDD（USB接続）を準備
- root権限またはsudo権限を持つユーザーでログイン可能

## 推定所要時間

30分

## 構築手順

### ステップ1: 外付けHDDの接続と確認

外付けHDDをUSBポートに接続し、Linuxが認識していることを確認します。

#### 実行コマンド

```bash
# デバイス一覧の確認
lsblk

# USB接続デバイスの確認
sudo fdisk -l | grep -i "Disk /dev/sd"

# dmesgで接続ログ確認
dmesg | tail -20
```

#### 期待される出力

```
sdb      8:16   0 931.5G  0 disk
└─sdb1   8:17   0 931.5G  0 part
```

#### 検証項目

- **アクション**: `lsblk` を実行し、新しいデバイス（例: sdb、sdc）が表示されるか確認する
- **期待結果**: 外付けHDDのデバイス名（例: /dev/sdb）が表示される
- **失敗時**: USBケーブル接続確認、別のUSBポート試行、`dmesg | grep -i usb` でエラー確認

**注意**: デバイス名（sdb, sdc等）は環境により異なります。以降の手順では `/dev/sdb1` と表記しますが、**実際のデバイス名に置き換えて**実行してください。

---

### ステップ2: 外付けHDDのパーティション確認とファイルシステム作成

外付けHDDのパーティション状態を確認し、必要に応じてファイルシステムを作成します。

#### 実行コマンド

```bash
# パーティション情報確認
sudo fdisk -l /dev/sdb

# ファイルシステム確認
sudo blkid /dev/sdb1
```

**既にファイルシステムが存在する場合**: ステップ3へ進む

**ファイルシステムが存在しない場合**: 以下を実行

```bash
# ext4ファイルシステムの作成（注意: データが削除されます）
sudo mkfs.ext4 /dev/sdb1

# ラベル設定（オプション）
sudo e2label /dev/sdb1 backup-hdd

# 確認
sudo blkid /dev/sdb1
```

#### 期待される出力

```
/dev/sdb1: LABEL="backup-hdd" UUID="xxxx-xxxx-xxxx-xxxx" TYPE="ext4"
```

#### 検証項目

- **アクション**: `sudo blkid /dev/sdb1 | grep ext4` を実行する
- **期待結果**: TYPE="ext4" が表示される
- **失敗時**: デバイス名が正しいか確認、`lsblk` で再度デバイス確認

**警告**: `mkfs.ext4` は**既存データをすべて削除**します。重要なデータがある場合は事前にバックアップしてください。

---

### ステップ3: マウントポイントの作成と外付けHDDのマウント

外付けHDD用のマウントポイントを作成し、手動マウントします。

#### 実行コマンド

```bash
# マウントポイントの作成
sudo mkdir -p /mnt/backup

# 外付けHDDのマウント
sudo mount /dev/sdb1 /mnt/backup

# マウント確認
df -h /mnt/backup
ls -la /mnt/backup
```

#### 期待される出力

```
Filesystem      Size  Used Avail Use% Mounted on
/dev/sdb1       916G  77M  870G   1% /mnt/backup
```

#### 検証項目

- **アクション**: `mount | grep /mnt/backup` を実行する
- **期待結果**: /dev/sdb1 が /mnt/backup にマウントされている
- **失敗時**: デバイスが使用中でないか確認、`sudo umount /mnt/backup` 後に再マウント

---

### ステップ4: UUIDの取得と/etc/fstab設定（自動マウント）

OS再起動後も自動マウントされるよう、/etc/fstab に設定を追加します。

#### 実行コマンド

```bash
# UUIDの取得
UUID=$(sudo blkid /dev/sdb1 | grep -oP 'UUID="\K[^"]+')
echo "UUID: $UUID"

# /etc/fstabへのエントリ追加
echo "UUID=$UUID /mnt/backup ext4 defaults,nofail 0 2" | sudo tee -a /etc/fstab

# 設定確認
sudo cat /etc/fstab | grep backup
```

#### 期待される出力

```
UUID: xxxx-xxxx-xxxx-xxxx
UUID=xxxx-xxxx-xxxx-xxxx /mnt/backup ext4 defaults,nofail 0 2
```

#### 検証項目

- **アクション**: `sudo mount -a` を実行し、エラーが出ないか確認する
- **期待結果**: エラーメッセージが表示されない
- **失敗時**: /etc/fstab の構文エラー確認、`sudo mount -a -v` で詳細確認

**注意**: `nofail` オプションにより、外付けHDD接続なしでもOSが起動します。

---

### ステップ5: バックアップディレクトリ構造の作成

バックアップ用のディレクトリ構造を作成します。

#### 実行コマンド

```bash
# バックアップディレクトリ作成
sudo mkdir -p /mnt/backup/docker/{volumes,images,compose,swarm,logs}

# 権限設定
sudo chown -R root:root /mnt/backup/docker
sudo chmod -R 755 /mnt/backup/docker

# 確認
tree -L 2 /mnt/backup/docker || ls -la /mnt/backup/docker
```

#### 期待される出力

```
/mnt/backup/docker
├── compose
├── images
├── logs
├── swarm
└── volumes
```

#### 検証項目

- **アクション**: `ls -la /mnt/backup/docker` を実行する
- **期待結果**: volumes, images, compose, swarm, logs ディレクトリが存在する
- **失敗時**: 権限エラーの場合は sudo を使用して再実行

---

### ステップ6: バックアップスクリプトの作成

週1回実行される自動バックアップスクリプトを作成します。

#### 実行コマンド

```bash
# バックアップスクリプトの作成
sudo tee /usr/local/bin/docker-backup.sh > /dev/null <<'EOF'
#!/bin/bash

# Docker バックアップスクリプト（エラーハンドリング強化版）
# 実行頻度: 週1回（日曜日 2:00AM）

set -eo pipefail

BACKUP_ROOT="/mnt/backup/docker"
DATE=$(date +%Y%m%d)
BACKUP_DIR="$BACKUP_ROOT/$DATE"
LOG_FILE="/var/log/docker-backup.log"
SUCCESS_COUNT=0
FAILURE_COUNT=0

# ログ記録関数
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# バックアップ開始
log "=== Docker Backup Started ==="

# マウント確認
if ! mountpoint -q /mnt/backup; then
    log "ERROR: /mnt/backup is not mounted. Aborting."
    exit 1
fi

# バックアップディレクトリ作成
mkdir -p "$BACKUP_DIR"/{volumes,images,compose,swarm}

# 1. Dockerボリュームのバックアップ
log "Backing up Docker volumes..."
if [ -d /data/docker/volumes ]; then
    if rsync -av /data/docker/volumes/ "$BACKUP_DIR/volumes/" >> "$LOG_FILE" 2>&1; then
        log "Volumes backup completed"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        log "ERROR: Volumes backup failed"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        [ -x /usr/local/bin/send-alert.sh ] && /usr/local/bin/send-alert.sh "バックアップ失敗: Dockerボリューム"
    fi
else
    log "WARNING: /data/docker/volumes not found"
fi

# 2. Dockerイメージのバックアップ
log "Backing up Docker images..."
if [ "$(docker images -q | wc -l)" -gt 0 ]; then
    if docker images --format "{{.Repository}}:{{.Tag}}" | \
        xargs -I {} docker save {} 2>/dev/null | \
        gzip > "$BACKUP_DIR/images/all-images-$DATE.tar.gz"; then
        log "Images backup completed: $(du -sh $BACKUP_DIR/images/all-images-$DATE.tar.gz 2>/dev/null | cut -f1)"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        log "ERROR: Images backup failed"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        [ -x /usr/local/bin/send-alert.sh ] && /usr/local/bin/send-alert.sh "バックアップ失敗: Dockerイメージ"
    fi
else
    log "INFO: No Docker images to backup"
fi

# 3. Docker Composeファイルのバックアップ
log "Backing up Docker Compose files..."
if [ -d /data/docker-compose ]; then
    if rsync -av /data/docker-compose/ "$BACKUP_DIR/compose/" >> "$LOG_FILE" 2>&1; then
        log "Compose files backup completed"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        log "ERROR: Compose files backup failed"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        [ -x /usr/local/bin/send-alert.sh ] && /usr/local/bin/send-alert.sh "バックアップ失敗: Docker Composeファイル"
    fi
else
    log "INFO: /data/docker-compose not found"
fi

# 4. Docker Swarm設定のバックアップ
log "Backing up Docker Swarm configs..."
if docker config ls --format "{{.Name}}" 2>/dev/null | \
    xargs -I {} docker config inspect {} > "$BACKUP_DIR/swarm/configs.json" 2>/dev/null && \
   docker secret ls --format "{{.Name}}" 2>/dev/null | \
    xargs -I {} docker secret inspect {} > "$BACKUP_DIR/swarm/secrets.json" 2>/dev/null; then
    log "Swarm configs backup completed"
    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
else
    log "WARNING: Swarm configs backup failed (may not be initialized)"
fi

# 5. チェックサム生成（整合性検証用）
log "Generating checksums..."
if cd "$BACKUP_DIR" && find . -type f -exec md5sum {} \; > checksums.md5 2>/dev/null; then
    log "Checksums saved: checksums.md5"
    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
else
    log "ERROR: Checksum generation failed"
    FAILURE_COUNT=$((FAILURE_COUNT + 1))
fi

# 6. バックアップファイルのパーミッション設定
chmod -R 600 "$BACKUP_DIR" 2>/dev/null || log "WARNING: Permission setting failed"

# 7. 古いバックアップの削除（30日以上古いもの）
log "Cleaning up old backups..."
find "$BACKUP_ROOT" -maxdepth 1 -type d -name "20*" -mtime +30 -exec rm -rf {} \;
log "Old backups cleaned"

# 最終結果
log "=== Docker Backup Completed ==="
log "Success: $SUCCESS_COUNT tasks, Failures: $FAILURE_COUNT tasks"
log "Total backup size: $(du -sh $BACKUP_DIR 2>/dev/null | cut -f1)"

if [ "$FAILURE_COUNT" -gt 0 ]; then
    log "WARNING: Backup completed with $FAILURE_COUNT failures"
    [ -x /usr/local/bin/send-alert.sh ] && /usr/local/bin/send-alert.sh "バックアップ部分失敗: $SUCCESS_COUNT成功, $FAILURE_COUNT失敗"
    exit 1
fi

exit 0
EOF

# スクリプトに実行権限付与
sudo chmod +x /usr/local/bin/docker-backup.sh

# スクリプト確認
ls -la /usr/local/bin/docker-backup.sh
```

#### 期待される出力

```
-rwxr-xr-x 1 root root ... /usr/local/bin/docker-backup.sh
```

#### 検証項目

- **アクション**: `sudo bash -n /usr/local/bin/docker-backup.sh` を実行する（構文チェック）
- **期待結果**: エラーメッセージが表示されない
- **失敗時**: スクリプト内容を再確認、シェルスクリプト構文エラーを修正

---

### ステップ7: バックアップスクリプトの手動実行テスト

スクリプトが正しく動作するか、手動実行してテストします。

#### 実行コマンド

```bash
# バックアップスクリプトの手動実行
sudo /usr/local/bin/docker-backup.sh

# ログ確認
sudo tail -30 /var/log/docker-backup.log

# バックアップファイル確認
ls -lh /mnt/backup/docker/$(date +%Y%m%d)/
```

#### 期待される出力

```
[2024-xx-xx xx:xx:xx] === Docker Backup Started ===
[2024-xx-xx xx:xx:xx] Backing up Docker volumes...
[2024-xx-xx xx:xx:xx] Volumes backup completed
[2024-xx-xx xx:xx:xx] Backing up Docker images...
[2024-xx-xx xx:xx:xx] Images backup completed: xxxM
[2024-xx-xx xx:xx:xx] === Docker Backup Completed ===
```

#### 検証項目

- **アクション**: `ls /mnt/backup/docker/$(date +%Y%m%d)` を実行する
- **期待結果**: volumes, images, compose, swarm ディレクトリが存在し、ファイルが格納されている
- **失敗時**: `/var/log/docker-backup.log` でエラー内容確認、マウントポイント確認

---

### ステップ8: cron設定（週1回自動実行）

cronを使用して、週1回（日曜日2:00AM）自動実行するよう設定します。

#### 実行コマンド

```bash
# cron設定ファイルの作成
sudo tee /etc/cron.d/docker-backup > /dev/null <<'EOF'
# Docker自動バックアップ
# 毎週日曜日 2:00AM に実行
0 2 * * 0 root /usr/local/bin/docker-backup.sh >> /var/log/docker-backup.log 2>&1
EOF

# cron設定の確認
sudo cat /etc/cron.d/docker-backup

# cronサービスの再読み込み
sudo systemctl reload crond

# cron実行ログ確認（次回実行時に確認）
sudo journalctl -u crond --since today
```

#### 期待される出力

```
# Docker自動バックアップ
# 毎週日曜日 2:00AM に実行
0 2 * * 0 root /usr/local/bin/docker-backup.sh >> /var/log/docker-backup.log 2>&1
```

#### 検証項目

- **アクション**: `sudo crontab -l -u root` または `ls /etc/cron.d/docker-backup` を実行する
- **期待結果**: docker-backup ファイルが存在し、設定が正しい
- **失敗時**: cron構文エラー確認、crondサービスが起動しているか確認 `systemctl status crond`

---

### ステップ9: リストア手順のテスト

バックアップからのリストア（復元）が正しく動作するかテストします。

#### 実行コマンド

```bash
# テスト用ボリュームの作成
docker volume create test-volume
echo "test data" | docker run --rm -v test-volume:/data alpine sh -c 'cat > /data/test.txt'

# データ確認
docker run --rm -v test-volume:/data alpine cat /data/test.txt

# バックアップ実行
sudo /usr/local/bin/docker-backup.sh

# テストボリュームを削除
docker volume rm test-volume

# リストア（復元）実行
BACKUP_DATE=$(date +%Y%m%d)
docker volume create test-volume
sudo rsync -av /mnt/backup/docker/$BACKUP_DATE/volumes/test-volume/_data/ \
    /var/lib/docker/volumes/test-volume/_data/

# データ復元確認
docker run --rm -v test-volume:/data alpine cat /data/test.txt

# クリーンアップ
docker volume rm test-volume
```

#### 期待される出力

```
test data
（バックアップログ）
test data
（リストア成功）
```

#### 検証項目

- **アクション**: リストア後のデータ確認で "test data" が表示されるか確認する
- **期待結果**: バックアップ前と同じデータが復元される
- **失敗時**: rsyncのパス確認、権限エラーの場合はsudo使用、バックアップファイルの存在確認

---

## 包括的動作確認手順

### 1. 外付けHDD状態確認

```bash
# マウント状態確認
mountpoint /mnt/backup
df -h /mnt/backup

# fstab設定確認
grep backup /etc/fstab

# ディスク使用状況確認
du -sh /mnt/backup/docker
```

**期待される結果**:
- /mnt/backup がマウントされている
- fstabに自動マウント設定が存在
- 十分な空き容量がある

---

### 2. バックアップスクリプト動作確認

```bash
# スクリプト存在確認
ls -la /usr/local/bin/docker-backup.sh

# 実行権限確認
sudo bash -n /usr/local/bin/docker-backup.sh

# 手動実行テスト
sudo /usr/local/bin/docker-backup.sh

# ログ確認
sudo tail -50 /var/log/docker-backup.log
```

**期待される結果**:
- スクリプトが実行可能
- エラーなく完了
- ログファイルに成功メッセージが記録

---

### 3. バックアップファイル確認

```bash
# バックアップディレクトリ確認
ls -la /mnt/backup/docker/$(date +%Y%m%d)

# ボリュームバックアップ確認
ls -la /mnt/backup/docker/$(date +%Y%m%d)/volumes/

# イメージバックアップ確認
ls -lh /mnt/backup/docker/$(date +%Y%m%d)/images/

# Composeファイル確認
ls -la /mnt/backup/docker/$(date +%Y%m%d)/compose/
```

**期待される結果**:
- 各ディレクトリにバックアップファイルが存在
- イメージファイルが適切なサイズ（数MB〜数GB）
- ボリュームディレクトリが存在

---

### 4. cron設定確認

```bash
# cron設定ファイル確認
sudo cat /etc/cron.d/docker-backup

# crondサービス状態確認
sudo systemctl status crond

# cron実行履歴確認（次回実行後）
sudo grep docker-backup /var/log/cron
```

**期待される結果**:
- cron設定ファイルが正しく配置されている
- crondサービスが active (running)
- 自動起動が有効

---

### 5. リストアテスト確認

```bash
# 最新バックアップ日付確認
LATEST_BACKUP=$(ls -1 /mnt/backup/docker/ | grep "^20" | sort -r | head -1)
echo "Latest backup: $LATEST_BACKUP"

# バックアップファイル数確認
find /mnt/backup/docker/$LATEST_BACKUP -type f | wc -l
```

**期待される結果**:
- 最新のバックアップディレクトリが存在
- 複数のバックアップファイルが存在

---

## 最終確認チェックリスト

以下の全項目が ✅ になることを確認してください：

- [ ] 外付けHDDが接続され、認識されている（`lsblk`）
- [ ] 外付けHDDがマウントされている（`mountpoint /mnt/backup`）
- [ ] /etc/fstab に自動マウント設定が追加されている
- [ ] バックアップディレクトリ構造が作成されている（`ls /mnt/backup/docker`）
- [ ] バックアップスクリプトが存在し、実行可能（`ls -la /usr/local/bin/docker-backup.sh`）
- [ ] バックアップスクリプトが手動実行で成功する
- [ ] バックアップログファイルが生成されている（`/var/log/docker-backup.log`）
- [ ] cron設定が正しく配置されている（`/etc/cron.d/docker-backup`）
- [ ] crondサービスが起動している（`systemctl status crond`）
- [ ] リストアテストが成功する
- [ ] 最新バックアップファイルが存在する（`ls /mnt/backup/docker/`）
- [ ] バックアップファイルのサイズが適切（数MB以上）
- [ ] 外付けHDD接続なしでもOS起動可能（nofailオプション）

## 次のステップ

**✅ 上記の全確認項目が成功した場合のみ**、次の手順に進んでください。

- **Phase 3.3**: 監視・セキュリティ設定（`procedures/3.3-monitoring-security-setup.md`）

問題が発見された場合は、該当するトラブルシューティングセクションを参照して解決してから次のフェーズに進行してください。

## トラブルシューティング

### 外付けHDDが認識されない

**症状**: `lsblk` に外付けHDDが表示されない

**確認**:
```bash
dmesg | tail -30
lsusb
```

**原因と対策**:
1. **USB接続不良**: ケーブル接続確認、別のUSBポート試行
2. **電源不足**: USB 3.0ポート使用、外部電源付きHDD使用
3. **ドライバ問題**: `sudo modprobe usb-storage` でドライバロード

---

### マウントエラー

**症状**: `sudo mount /dev/sdb1 /mnt/backup` がエラー

**確認**:
```bash
sudo mount -v /dev/sdb1 /mnt/backup
dmesg | grep -i error
```

**原因と対策**:
1. **既にマウント済み**: `sudo umount /mnt/backup` 後に再マウント
2. **ファイルシステム不正**: `sudo fsck /dev/sdb1` で修復
3. **権限不足**: sudo を使用して実行

---

### バックアップスクリプト失敗

**症状**: バックアップスクリプトがエラーで終了

**確認**:
```bash
sudo /usr/local/bin/docker-backup.sh
sudo cat /var/log/docker-backup.log
```

**原因と対策**:
1. **/mnt/backup未マウント**: `mountpoint /mnt/backup` 確認、手動マウント
2. **ディスク容量不足**: `df -h /mnt/backup` 確認、古いバックアップ削除
3. **権限エラー**: スクリプトをroot権限で実行

---

### cron自動実行されない

**症状**: 日曜日2:00AMにバックアップが実行されない

**確認**:
```bash
sudo systemctl status crond
sudo grep docker-backup /var/log/cron
sudo cat /etc/cron.d/docker-backup
```

**原因と対策**:
1. **crondサービス停止**: `sudo systemctl start crond && sudo systemctl enable crond`
2. **cron構文エラー**: `/etc/cron.d/docker-backup` の構文確認
3. **時刻ずれ**: `timedatectl` で時刻確認、NTP同期設定

---

### リストア失敗

**症状**: バックアップからの復元ができない

**確認**:
```bash
ls -la /mnt/backup/docker/$(date +%Y%m%d)/volumes/
ls -la /var/lib/docker/volumes/
```

**原因と対策**:
1. **バックアップファイル不在**: バックアップが正常実行されたか確認
2. **パス間違い**: rsyncのソース・宛先パス確認
3. **権限エラー**: sudo を使用してリストア実行

---

## 修正履歴

### Version 1.1 (2025-01-28)
**修正内容**:
1. **バックアップスクリプトのエラーハンドリング強化** (課題#4対応 - 🔴 CRITICAL)
   - 理由: 部分的バックアップ失敗時の処理が不明確で、サイレント障害のリスクがあった
   - 追加機能:
     - SUCCESS_COUNT/FAILURE_COUNTカウンタによる成功/失敗追跡
     - 各バックアップステップでの個別エラーハンドリング
     - 失敗時のDiscordアラート送信（send-alert.sh経由）
     - 部分失敗時の exit 1 による明確な失敗通知
   - 影響: バックアップ障害の早期検知と対応が可能に

2. **バックアップ整合性検証の自動化** (課題#7対応 - 🟡 IMPORTANT)
   - 理由: バックアップファイルの破損検知機構が欠如していた
   - 追加機能:
     - md5sumによるチェックサム自動生成
     - checksums.md5ファイルへの保存
     - 将来のリストア前検証に利用可能
   - 影響: データ整合性の保証とリストア信頼性の向上

3. **バックアップファイルのパーミッション設定** (課題#4関連 - 🟡 IMPORTANT)
   - 理由: セキュリティ強化のため機密データの権限制御が必要
   - 追加機能:
     ```bash
     chmod -R 600 "$BACKUP_DIR"
     ```
   - 影響: root以外からのアクセスを防止、セキュリティ向上

4. **rsync --deleteオプションの削除** (課題#1関連 - 🟡 IMPORTANT)
   - 理由: 初回バックアップでのデータ喪失リスク軽減
   - 変更: `rsync -av --delete` → `rsync -av`
   - 影響: 安全性の向上（ディスク容量管理は別途実施）

**期待される出力例**:
```
[2025-01-28 02:00:15] === Docker Backup Started ===
[2025-01-28 02:00:20] Volumes backup completed
[2025-01-28 02:00:45] Images backup completed: 2.3G
[2025-01-28 02:00:50] Compose files backup completed
[2025-01-28 02:00:52] Swarm configs backup completed
[2025-01-28 02:01:10] Checksums saved: checksums.md5
[2025-01-28 02:01:15] Old backups cleaned
[2025-01-28 02:01:15] === Docker Backup Completed ===
[2025-01-28 02:01:15] Success: 5 tasks, Failures: 0 tasks
[2025-01-28 02:01:15] Total backup size: 2.5G
```

**影響度評価**:
- 🔴 CRITICAL: バックアップ失敗検知機能（課題#4）
- 🟡 IMPORTANT: 整合性検証（課題#7）、パーミッション設定、rsync安全化

---

**END OF DOCUMENT**
